# ETF资产配置策略系统 - 数据存储重新设计方案

## 📋 设计原则

### 核心设计理念
1. **大模型友好**: 数据格式便于大模型读取和理解
2. **存储分离**: 配置数据文件存储，业务数据数据库存储
3. **多源聚合**: 不同数据源统一存储到MySQL数据库
4. **结构优化**: 数据库表结构便于大模型工具调用

## 🗂️ 存储方案划分

### 文件存储数据（便于大模型读取）

#### 1. 业务配置文件
| 文件路径 | 内容 | 格式 | 用途 |
|---------|------|------|------|
| `config/business_flows.yaml` | 业务流程定义和状态转换规则 | YAML | 智能体业务逻辑配置 |
| `config/prompt_templates.yaml` | 各阶段提示词模板 | YAML | 大模型提示词管理 |
| `config/strategy_templates.json` | 标准策略模板和参数 | JSON | 策略生成模板 |
| `config/investment_rules.yaml` | 投资规则和约束条件 | YAML | 投资决策规则 |

#### 2. 用户数据文件
| 文件路径 | 内容 | 格式 | 用途 |
|---------|------|------|------|
| `data/user_profiles/{user_id}/profile.json` | 用户投资偏好和历史行为 | JSON | 大模型用户画像分析 |
| `data/user_profiles/{user_id}/strategies.json` | 用户策略配置详情 | JSON | 策略配置管理 |
| `data/sessions/{user_id}/{session_id}.json` | 对话上下文和要素提取 | JSON | 对话上下文分析 |

#### 3. 知识库文件
| 文件路径 | 内容 | 格式 | 用途 |
|---------|------|------|------|
| `knowledge/etf_categories.json` | ETF分类和标签体系 | JSON | ETF分类查询 |
| `knowledge/investment_concepts.yaml` | 投资概念和术语解释 | YAML | 投资知识库 |
| `knowledge/risk_profiles.json` | 风险等级定义和特征 | JSON | 风险评估参考 |

### 数据库存储数据（结构化查询）

#### 1. ETF数据表（多源聚合）
- **etf_basic_info** - ETF基础信息（Wind数据源）
- **etf_price_data** - ETF价格数据（Wind数据源）
- **etf_performance_metrics** - ETF绩效指标（Wind数据源计算）

#### 2. 市场数据表（多源聚合）
- **market_index_data** - 市场指数数据（Wind数据源）
- **sector_data** - 行业板块数据（Wind数据源）

#### 3. 新闻资讯表（多源聚合）
- **financial_news** - 财经新闻（新浪财经、东方财富等）
- **research_reports** - 研究报告（多个券商研报API）
- **market_hotspots** - 市场热点（数据聚合分析）

#### 4. 用户系统表
- **users** - 用户基础信息
- **user_strategies** - 用户策略记录（指向文件）
- **user_conversations** - 用户对话记录（指向文件）

## 🎯 面向大模型的数据库设计

### 表结构设计特点

#### 1. 语义化字段设计
```sql
-- 示例：ETF基础信息表
CREATE TABLE etf_basic_info (
    id INT PRIMARY KEY AUTO_INCREMENT,
    etf_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'ETF代码，如510300.SH',
    etf_name VARCHAR(100) NOT NULL COMMENT 'ETF名称，如沪深300ETF',
    investment_objective TEXT COMMENT '投资目标描述，便于大模型理解',
    investment_strategy TEXT COMMENT '投资策略详细说明',
    risk_characteristics TEXT COMMENT '风险特征描述',
    suitable_investors TEXT COMMENT '适合投资者类型描述',
    -- 其他字段...
);
```

#### 2. 丰富的描述性字段
- **长文本字段**: 存储详细描述，便于大模型语义理解
- **JSON标签字段**: 存储结构化标签和分类信息
- **关联关系字段**: 明确数据间的关联关系
- **元数据字段**: 记录数据来源、处理状态等信息

#### 3. 大模型查询优化
```sql
-- 示例：新闻表的大模型友好设计
CREATE TABLE financial_news (
    id INT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL COMMENT '新闻标题',
    summary TEXT COMMENT '新闻摘要',
    content LONGTEXT COMMENT '新闻正文',
    tags JSON COMMENT '新闻标签，如["ETF", "科技股", "市场分析"]',
    related_etfs JSON COMMENT '相关ETF代码数组',
    sentiment_score DECIMAL(3,2) COMMENT '情感倾向评分，-1到1',
    investment_implications TEXT COMMENT '投资含义分析，便于大模型理解',
    market_impact TEXT COMMENT '市场影响描述',
    -- 索引优化
    INDEX idx_publish_time (publish_time),
    INDEX idx_category (category),
    INDEX idx_sentiment_score (sentiment_score)
);
```

## 🔄 数据流转机制

### 多源数据聚合流程

#### 1. ETF数据聚合
```
Wind数据库 → 数据清洗 → 标准化处理 → MySQL存储
                ↓
        添加描述性文本 → 生成投资建议 → 大模型工具调用
```

#### 2. 新闻资讯聚合
```
多个API源 → 内容抓取 → 情感分析 → 关联分析 → MySQL存储
    ↓           ↓         ↓         ↓
新浪财经    标题提取   大模型分析  ETF关联    结构化存储
东方财富    摘要生成   情感评分   行业关联    便于查询
其他源      标签提取   投资含义   热点识别
```

#### 3. 用户数据混合存储
```
用户操作 → 结构化数据 → MySQL存储（认证、策略记录）
           ↓
        上下文数据 → JSON文件存储（档案、会话）
           ↓
        大模型读取 → 分析理解 → 生成响应
```

## 🛠️ 技术实现要点

### 1. 文件操作工具类
```python
class FileDataManager:
    """文件数据管理器"""
    
    def read_user_profile(self, user_id: int) -> Dict[str, Any]:
        """读取用户投资档案"""
        
    def write_user_profile(self, user_id: int, profile_data: Dict[str, Any]):
        """写入用户投资档案"""
        
    def read_session_context(self, user_id: int, session_id: str) -> Dict[str, Any]:
        """读取对话会话上下文"""
        
    def write_session_context(self, user_id: int, session_id: str, context: Dict[str, Any]):
        """写入对话会话上下文"""
        
    def read_business_config(self, config_name: str) -> Dict[str, Any]:
        """读取业务配置文件"""
```

### 2. 多源数据同步器
```python
class MultiSourceDataSync:
    """多源数据同步器"""
    
    def sync_wind_etf_data(self):
        """同步Wind ETF数据到MySQL"""
        
    def sync_news_from_multiple_sources(self):
        """从多个源同步新闻数据"""
        
    def enrich_data_with_llm_analysis(self):
        """使用大模型丰富数据描述"""
```

### 3. 大模型数据查询器
```python
class LLMDataQueryHelper:
    """大模型数据查询辅助器"""
    
    def get_etf_data_for_llm(self, query_intent: str) -> str:
        """为大模型准备ETF数据文本"""
        
    def get_news_analysis_for_llm(self, keywords: List[str]) -> str:
        """为大模型准备新闻分析文本"""
        
    def format_data_for_llm_context(self, data: Dict[str, Any]) -> str:
        """格式化数据为大模型上下文"""
```

## 📊 存储效果对比

### 存储效率对比
| 数据类型 | 原方案 | 新方案 | 优势 |
|---------|--------|--------|------|
| **用户对话** | 全部数据库 | 文件存储 | 大模型直接读取，无需SQL查询 |
| **业务配置** | 数据库表 | YAML文件 | 版本控制，便于修改和理解 |
| **策略模板** | 硬编码 | JSON文件 | 灵活配置，便于大模型理解 |
| **ETF数据** | 单一来源 | 多源聚合 | 数据更全面，描述更丰富 |
| **新闻资讯** | 实时获取 | 聚合存储 | 便于分析，支持历史查询 |

### 大模型交互优化
| 方面 | 优化内容 | 效果 |
|------|---------|------|
| **数据理解** | 丰富的文本描述字段 | 提升语义理解准确性 |
| **上下文获取** | JSON文件直接读取 | 减少数据库查询，提升响应速度 |
| **知识库查询** | 结构化知识文件 | 便于知识检索和推理 |
| **数据关联** | JSON格式关联信息 | 便于理解数据间关系 |

## 🚀 实施建议

### 阶段1: 数据库表结构调整
1. 重新设计ETF、新闻、市场数据表
2. 添加面向大模型的描述性字段
3. 优化索引设计，支持大模型查询模式

### 阶段2: 文件存储系统建立
1. 创建文件存储目录结构
2. 实现文件数据管理器
3. 建立文件版本控制机制

### 阶段3: 多源数据同步
1. 实现Wind数据库同步器
2. 实现新闻资讯多源聚合器
3. 建立数据质量控制机制

### 阶段4: 大模型工具适配
1. 更新LangChain工具，支持文件读取
2. 优化数据查询接口
3. 完善大模型数据格式化

## 📝 总结

通过数据存储重新设计，实现了：

✅ **存储职责分离**: 配置文件存储，业务数据数据库存储
✅ **大模型友好**: 文件格式便于直接读取，数据库字段语义化
✅ **多源数据统一**: 不同数据源聚合到同一MySQL数据库
✅ **查询性能优化**: 针对大模型查询模式优化索引
✅ **维护便利性**: 配置文件版本控制，数据库结构清晰

新的存储方案既满足了大模型的数据需求，又保证了系统的性能和可维护性。
